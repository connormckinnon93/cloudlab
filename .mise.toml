[tools]
terraform = "1.14"
talosctl = "1.12"
sops = "3.11"
age = "1.3"
kubectl = "1.32"
tflint = "0.61"
lefthook = "2.1"
gitleaks = "8.30"

[env]
SOPS_AGE_KEY_FILE = "{{config_root}}/.age-key.txt"
TALOSCONFIG = "{{config_root}}/terraform/output/talosconfig.yaml"
KUBECONFIG = "{{config_root}}/terraform/output/kubeconfig.yaml"

[tasks.setup]
description = "Install tools, initialize tflint, install lefthook"
run = """
mise install
cd terraform && tflint --init && terraform init
lefthook install
"""

[tasks.tf]
description = "Run any terraform command (e.g., mise run tf plan)"
dir = "terraform"
usage = 'arg "<command>" help="Terraform subcommand (plan, init, fmt, destroy, etc.)" arg "[extra]" var=#true help="Extra arguments"'
run = "terraform ${usage_command?} ${usage_extra:-}"

[tasks.check]
description = "Run all linters and validators"
dir = "terraform"
run = """
set -e
terraform fmt -check
terraform validate
tflint
"""

[tasks."config:export"]
description = "Extract and encrypt talosconfig and kubeconfig"
hide = true
dir = "terraform"
run = """
set -e
mkdir -p output
terraform output -raw talosconfig > output/talosconfig.enc.yaml
sops encrypt -i output/talosconfig.enc.yaml
terraform output -raw kubeconfig > output/kubeconfig.enc.yaml
sops encrypt -i output/kubeconfig.enc.yaml
"""

[tasks."config:decrypt"]
description = "Decrypt configs for local use (scoped to project via mise env)"
dir = "terraform"
run = """
set -e
(umask 077 && sops decrypt output/talosconfig.enc.yaml > output/talosconfig.yaml)
(umask 077 && sops decrypt output/kubeconfig.enc.yaml > output/kubeconfig.yaml)
"""

[tasks."sops:edit"]
description = "Decrypt, edit, and re-encrypt secrets"
raw = true
usage = 'arg "[file]" help="File to edit" default="terraform/secrets.enc.json"'
run = "sops ${usage_file?}"

[tasks."talos:upgrade"]
description = "Upgrade TalosOS to a new version"
usage = """
arg "<schematic_id>" help="Schematic ID from factory.talos.dev"
arg "<version>" help="TalosOS version to upgrade to"
"""
run = "talosctl upgrade --image factory.talos.dev/installer/${usage_schematic_id?}:${usage_version?} --preserve"
