[tools]
terraform = "1.14"
talosctl = "1.12"
sops = "3.11"
age = "1.3"
kubectl = "1.32"
tflint = "0.61"
lefthook = "2.1"
gitleaks = "8.30"
kustomize = "5.8"
kubeconform = "0.7"
flux2 = "2.7"
helm = "3.17"
kyverno = "1.17"
"aqua:kyverno/chainsaw" = "0.2.14"
trivy = "0.62"
"aqua:FairwindsOps/pluto" = "5.21"
kube-linter = "0.7"

[env]
SOPS_AGE_KEY_FILE = "{{config_root}}/.age-key.txt"
TALOSCONFIG = "{{config_root}}/terraform/output/talosconfig.yaml"
KUBECONFIG = "{{config_root}}/terraform/output/kubeconfig.yaml"

[tasks.setup]
description = "Install tools, initialize tflint, install lefthook"
run = """
mise install
cd terraform && tflint --init && terraform init
lefthook install
"""

[tasks.tf]
description = "Run any terraform command (e.g., mise run tf plan)"
dir = "terraform"
usage = 'arg "<command>" help="Terraform subcommand (plan, init, fmt, destroy, etc.)" arg "[extra]" var=#true help="Extra arguments"'
run = "terraform ${usage_command?} ${usage_extra:-}"

[tasks.check]
description = "Run all linters and validators"
run = """
set -e
echo "==> Terraform"
(cd terraform && terraform fmt -check && terraform validate && tflint)
echo "==> Terraform Tests"
(cd terraform && terraform test)
if [ -d kubernetes ]; then
  echo "==> Kubernetes"
  for dir in kubernetes/*/; do
    if [ -f "${dir}kustomization.yaml" ]; then
      echo "    $dir"
      # Strip SOPS metadata blocks (kubeconform rejects the non-standard sops: key).
      # Uses explicit {print} instead of bare !s for macOS awk compatibility.
      kustomize build "$dir" | awk 'BEGIN{s=0} /^sops:/{s=1;next} s==1&&/^[^[:space:]]/{s=0} s==0{print}' | kubeconform -strict -summary -ignore-missing-schemas \
        -schema-location default \
        -schema-location 'https://raw.githubusercontent.com/datreeio/CRDs-catalog/main/{% raw %}{{.Group}}/{{.ResourceKind}}_{{.ResourceAPIVersion}}{% endraw %}.json'
    fi
  done
fi
if [ -d tests/kyverno ] && ls tests/kyverno/*/kyverno-test.yaml >/dev/null 2>&1; then
  echo "==> Kyverno Policy Tests"
  kyverno test tests/kyverno/
fi
echo "==> Gitleaks"
gitleaks git
"""

[tasks."tf:test"]
description = "Run Terraform tests"
dir = "terraform"
run = "terraform test"

[tasks.security]
description = "Run security scanning (trivy, pluto, kube-linter)"
run = """
set -e
echo "==> Trivy (Terraform)"
trivy config --severity HIGH,CRITICAL terraform/
echo "==> Trivy (Kubernetes)"
trivy config --severity HIGH,CRITICAL --ignorefile .trivyignore kubernetes/
echo "==> Pluto"
pluto detect-files -d kubernetes/ --ignore-deprecations --ignore-removals --target-versions k8s=v1.32.0
echo "==> kube-linter"
kube-linter lint kubernetes/ --config .kube-linter.yaml || true  # Advisory â€” Helm-managed resources may trigger false positives
"""

[tasks.e2e]
description = "Run E2E tests against the live cluster"
run = """
set -e
echo "==> Chainsaw E2E"
chainsaw test --test-dir tests/e2e/
"""

[tasks."test:all"]
description = "Run all tests (check + security)"
run = """
set -e
mise run check
mise run security
"""

[tasks."config:export"]
description = "Extract and encrypt talosconfig and kubeconfig"
hide = true
dir = "terraform"
run = """
set -e
mkdir -p output
terraform output -raw talosconfig > output/talosconfig.enc.yaml
sops encrypt -i output/talosconfig.enc.yaml
terraform output -raw kubeconfig > output/kubeconfig.enc.yaml
sops encrypt -i output/kubeconfig.enc.yaml
"""

[tasks."config:decrypt"]
description = "Decrypt configs for local use (scoped to project via mise env)"
dir = "terraform"
run = """
set -e
(umask 077 && sops decrypt output/talosconfig.enc.yaml > output/talosconfig.yaml)
(umask 077 && sops decrypt output/kubeconfig.enc.yaml > output/kubeconfig.yaml)
"""

[tasks."tf:provision"]
description = "Apply Terraform, re-bootstrap, and refresh local configs"
dir = "terraform"
run = """
set -e
terraform apply -replace=talos_machine_bootstrap.this -replace=talos_cluster_kubeconfig.this
mkdir -p output
terraform output -raw talosconfig > output/talosconfig.enc.yaml
sops encrypt -i output/talosconfig.enc.yaml
terraform output -raw kubeconfig > output/kubeconfig.enc.yaml
sops encrypt -i output/kubeconfig.enc.yaml
(umask 077 && sops decrypt output/talosconfig.enc.yaml > output/talosconfig.yaml)
(umask 077 && sops decrypt output/kubeconfig.enc.yaml > output/kubeconfig.yaml)
echo "Done. Verify with: kubectl get nodes"
"""

[tasks."sops:edit"]
description = "Decrypt, edit, and re-encrypt secrets"
raw = true
usage = 'arg "[file]" help="File to edit" default="terraform/secrets.enc.json"'
run = "sops ${usage_file?}"

[tasks."talos:upgrade"]
description = "Upgrade TalosOS to a new version"
usage = """
arg "<schematic_id>" help="Schematic ID from factory.talos.dev"
arg "<version>" help="TalosOS version to upgrade to"
"""
run = "talosctl upgrade --image factory.talos.dev/installer-secureboot/${usage_schematic_id?}:${usage_version?} --preserve"

[tasks."dns:set"]
description = "Point local DNS at AdGuard Home (192.168.20.100)"
run = """
set -e
for iface in "Ethernet" "USB 10/100/1G/2.5G LAN" "Wi-Fi"; do
  echo "Setting DNS on $iface..."
  networksetup -setdnsservers "$iface" 192.168.20.100
done
echo "DNS updated. Verifying..."
for iface in "Ethernet" "USB 10/100/1G/2.5G LAN" "Wi-Fi"; do
  echo "  $iface: $(networksetup -getdnsservers "$iface" 2>&1)"
done
"""

[tasks."dns:unset"]
description = "Revert local DNS to DHCP defaults"
run = """
set -e
for iface in "Ethernet" "USB 10/100/1G/2.5G LAN" "Wi-Fi"; do
  echo "Clearing DNS on $iface..."
  networksetup -setdnsservers "$iface" empty
done
echo "DNS reverted to DHCP. Verifying..."
for iface in "Ethernet" "USB 10/100/1G/2.5G LAN" "Wi-Fi"; do
  echo "  $iface: $(networksetup -getdnsservers "$iface" 2>&1)"
done
"""

[tasks."flux:sops-key"]
description = "Create or rotate the sops-age Secret in flux-system"
run = """
set -e
if kubectl get secret sops-age -n flux-system >/dev/null 2>&1; then
  kubectl delete secret sops-age -n flux-system
fi
kubectl create secret generic sops-age \
  --namespace=flux-system \
  --from-file=age.agekey=.age-key.txt
"""
