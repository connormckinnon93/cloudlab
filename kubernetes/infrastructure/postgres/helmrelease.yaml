apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: postgres-cluster
  namespace: postgres
spec:
  interval: 30m
  timeout: 5m
  dependsOn:
    - name: cloudnative-pg
      namespace: cnpg-system
  chart:
    spec:
      chart: cluster
      version: "0.5.0"
      interval: 60m
      sourceRef:
        kind: HelmRepository
        name: cloudnative-pg
        namespace: cnpg-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    version:
      postgresql: "17.8"

    cluster:
      instances: 1

      storage:
        size: 5Gi
        storageClass: nfs

      resources:
        requests:
          cpu: 100m
          memory: 128Mi
        limits:
          memory: 256Mi

      postgresql:
        parameters:
          shared_buffers: "64MB"
          effective_cache_size: "128MB"
          work_mem: "4MB"
          maintenance_work_mem: "32MB"
          max_connections: "50"

      enableSuperuserAccess: false

      monitoring:
        enabled: false

      initdb:
        database: authentik
        owner: authentik
        secret:
          name: cnpg-authentik-credentials

