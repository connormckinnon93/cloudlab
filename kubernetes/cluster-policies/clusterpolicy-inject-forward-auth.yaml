apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: inject-authentik-forward-auth
spec:
  rules:
    - name: generate-forward-auth-middleware
      match:
        any:
          - resources:
              kinds:
                - HTTPRoute
      exclude:
        any:
          - resources:
              selector:
                matchLabels:
                  auth.catinthehack.ca/skip: "true"
      generate:
        generateExisting: true
        synchronize: true
        apiVersion: traefik.io/v1alpha1
        kind: Middleware
        name: authentik-forward-auth
        namespace: "{{request.object.metadata.namespace}}"
        data:
          spec:
            forwardAuth:
              address: http://ak-outpost-traefik-outpost.authentik.svc.cluster.local:9000/outpost.goauthentik.io/auth/traefik
              trustForwardHeader: true
              authResponseHeaders:
                - X-authentik-username
                - X-authentik-groups
                - X-authentik-entitlements
                - X-authentik-email
                - X-authentik-name
                - X-authentik-uid
                - X-authentik-jwt
                - X-authentik-meta-jwks
                - X-authentik-meta-outpost
                - X-authentik-meta-provider
                - X-authentik-meta-app
                - X-authentik-meta-version
    - name: add-forward-auth-filter
      match:
        any:
          - resources:
              kinds:
                - HTTPRoute
      exclude:
        any:
          - resources:
              selector:
                matchLabels:
                  auth.catinthehack.ca/skip: "true"
      mutate:
        foreach:
          - list: "request.object.spec.rules"
            patchesJson6902: |-
              - op: add
                path: /spec/rules/{{elementIndex}}/filters
                value:
                  - type: ExtensionRef
                    extensionRef:
                      group: traefik.io
                      kind: Middleware
                      name: authentik-forward-auth
